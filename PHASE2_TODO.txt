================================================================================
숲똑 (SoopTalk) — 전체 프로젝트 컨텍스트 + Phase 2 작업 현황
================================================================================
최종 업데이트: 2026-02-08
Phase 2 상태: 전체 완료 (Step 7/7), pnpm run build 성공

################################################################################
# PART 1: PRD 요약
################################################################################

제품명: 숲똑 — 숲체험 예약 플랫폼
목적: 부모에게 "신뢰할 수 있는 자연 교육 기회", 강사에게 "활동 집중 운영 효율" 제공

타겟 유저:
  - PARENT (부모): 주말 아이 활동, 쉬운 예약/결제, 사진 확인
  - INSTRUCTOR (강사): 수강생 관리, 공지 자동화, 포트폴리오
  - ADMIN: 정산, 콘텐츠 검수

테크 스택:
  - Frontend: React Native (모바일), React/Next.js (강사 웹)
  - Backend: NestJS (Node.js)
  - Database: PostgreSQL + Prisma ORM
  - Storage: AWS S3
  - Infra: AWS (EC2, RDS, Lambda)

핵심 데이터 모델 (Phase 2 완료 기준):
  - User: id, email, role, phone_number, fcm_token + checkedAttendances 관계
  - Program: id, instructor_id, title, description, location(geo), price, max_capacity, min_age, schedule_at
  - Reservation: id, user_id, program_id, status, participant_count, total_price + payment/attendance 관계
  - Gallery: id, program_id, image_url
  - Payment: id, reservation_id(1:1), method, portone_payment_id, amount, status, paid_at, refunded_amount, refunded_at
  - Attendance: id, reservation_id(1:1), status, qr_code, checked_at, checked_by

개발 로드맵:
  Phase 0: 프로젝트 초기 세팅 (모노레포) ← 완료
  Phase 1: Auth + 프로그램 조회 + 단순 예약 (MVP) ← 완료
  Phase 2: 결제 모듈 + 강사 관리 고도화 ← 완료
  Phase 3: 알림 자동화 + 사진첩 고도화
  Phase 4: 정산 시스템 + 어드민 대시보드

환불 정책: 2일 전 100%, 1일 전 50%, 당일 환불 불가
동시성: Redis 분산 락 (SET NX PX + Lua release)

################################################################################
# PART 2: Phase 0 완료 현황 — 프로젝트 초기 세팅
################################################################################

Phase 0 목표: PRD 기반 모노레포 프로젝트를 빈 상태에서 구성

기술 스택 (확정):
  - Monorepo: Turborepo + pnpm workspaces
  - Mobile App: React Native (Expo)
  - Admin/Instructor Web: Next.js (App Router)
  - Backend API: NestJS
  - Shared: 공통 타입, 상수
  - DB: PostgreSQL + Prisma ORM
  - Language: TypeScript 전체 통일

디렉토리 구조:
  C:\Users\y00jh\project\
  ├── prd.txt
  ├── package.json              # 루트 (workspaces 정의, name: sooptalk)
  ├── pnpm-workspace.yaml       # workspace 범위: apps/*, packages/*
  ├── turbo.json                # build, dev, lint 파이프라인
  ├── .gitignore                # node_modules, .env, dist, .next, .expo 등
  ├── .eslintrc.js              # TypeScript + Prettier 통합
  ├── .prettierrc               # 기본 포맷팅 규칙
  ├── apps/
  │   ├── mobile/               # React Native (Expo)
  │   ├── admin/                # Next.js (강사/어드민 웹)
  │   └── server/               # NestJS (백엔드 API)
  └── packages/
      └── shared/               # 공통 타입, 상수

Phase 0 작업 순서 (모두 완료):
  Step 1: Git 초기화 + 루트 설정
  Step 2: 코드 품질 도구
  Step 3: 공유 패키지 (packages/shared)
  Step 4: 백엔드 (apps/server)
  Step 5: 어드민 웹 (apps/admin)
  Step 6: 모바일 앱 (apps/mobile)
  Step 7: 검증

################################################################################
# PART 3: Phase 1 완료 현황 — Auth + 프로그램 + 예약 MVP
################################################################################

Phase 1에서 구현 완료된 것:

[인증 (AuthModule)]
  - JWT 기반 인증 (access token)
  - 카카오 OAuth2 로그인
  - 로컬 회원가입 (bcrypt 비밀번호 해싱)
  - Role 기반 가드 (PARENT, INSTRUCTOR, ADMIN)

[프로그램 관리 (ProgramsModule)]
  - CRUD 완성 (강사가 활동 등록/수정/삭제)
  - 공개 검색/조회

[예약 (ReservationsModule) — Phase 1 시점]
  - POST /reservations — 예약 생성 (즉시 CONFIRMED, 잔여석 검증)
  - GET /reservations — 내 예약 목록 (status 필터)
  - GET /reservations/:id — 예약 상세
  - PATCH /reservations/:id/cancel — 예약 취소 (환불 비율만 계산, PG 환불 없음)

[공통]
  - Prisma ORM + PostgreSQL
  - Swagger 문서 (/api-docs)
  - 환경변수: DATABASE_URL, PORT, JWT_SECRET, KAKAO_REST_API_KEY
  - 모노레포: pnpm workspace (apps/server, packages/shared)

################################################################################
# PART 4: Phase 2 완료 현황 — 결제 모듈 + 강사 관리 고도화
################################################################################

Phase 2 결정 사항:
  PG: PortOne V2 REST API (fetch 직접 호출, SDK 미사용)
  Redis: ioredis
  출석: 수동 체크 + QR 코드 스캔 둘 다 지원

결제 플로우:
  클라이언트 → POST /reservations → PENDING 예약 생성 (Redis 분산 락)
           → POST /payments/prepare → Payment PENDING + PortOne 사전등록
           → 클라이언트에서 PortOne SDK로 결제 진행
           → PortOne → POST /payments/webhook
           → Payment PAID + Reservation CONFIRMED + Attendance(QR) 생성

취소/환불 플로우:
  클라이언트 → PATCH /reservations/:id/cancel
           → 환불 비율 계산 → PortOne 환불 API → Payment REFUNDED/PARTIAL_REFUND

Phase 2 Step별 완료 내역:

  Step 1: Shared 패키지 타입/상수 추가                              [완료]
    - packages/shared/src/types/payment.ts 신규 (PaymentMethod, PaymentStatus enum + Payment interface)
    - packages/shared/src/types/attendance.ts 신규 (AttendanceStatus enum + Attendance interface)
    - packages/shared/src/constants/index.ts 수정 (REDIS_LOCK_TTL_MS, REDIS_LOCK_RETRY_INTERVAL_MS, REDIS_LOCK_MAX_RETRIES 추가)
    - packages/shared/src/index.ts 수정 (새 타입/상수 export 추가)
    - pnpm --filter @sooptalk/shared build 성공

  Step 2: Prisma 스키마 + 의존성                                    [완료]
    - schema.prisma 수정: PaymentMethod, PaymentStatus, AttendanceStatus enum 추가
    - Payment, Attendance 모델 추가 (각각 Reservation과 1:1 관계)
    - Reservation에 payment/attendance 관계, User에 checkedAttendances 관계 추가
    - apps/server/package.json에 ioredis 추가
    - pnpm install + prisma generate 성공

  Step 3: RedisModule                                               [완료]
    - redis.service.ts: ioredis 연결, acquireLock(SET NX PX), releaseLock(Lua 스크립트), onModuleDestroy
    - redis.module.ts: @Global() 모듈

  Step 4: PaymentsModule                                            [완료]
    - portone.service.ts: PortOne V2 REST API 래퍼 (preRegister, getPaymentDetail, requestRefund)
    - dto/prepare-payment.dto.ts: reservationId + method
    - dto/webhook-payload.dto.ts: type + data.paymentId (PortOne V2 웹훅 구조)
    - payments.service.ts: preparePayment, handleWebhook(금액검증+트랜잭션), processRefund
    - payments.controller.ts: POST /payments/prepare (JWT), POST /payments/webhook (인증없음)
    - payments.module.ts: providers + exports PaymentsService

  Step 5: ReservationsModule 수정                                   [완료]
    - reservations.service.ts:
      create() → Redis 분산 락 + PENDING으로 생성 (기존: 즉시 CONFIRMED)
      cancel() → payment 있으면 PaymentsService.processRefund() 호출 (기존: 비율만 계산)
    - reservations.module.ts: PaymentsModule import 추가

  Step 6: AttendanceModule                                          [완료]
    - dto/mark-attendance.dto.ts: reservationId + status
    - dto/verify-qr.dto.ts: qrCode
    - attendance.service.ts: markAttendance(수동), getQrCode(QR조회), verifyQrCode(QR스캔)
    - attendance.controller.ts:
      POST /attendance/check (INSTRUCTOR) — 수동 출석 체크
      GET /attendance/qr/:reservationId (JWT) — QR 코드 조회
      POST /attendance/qr/verify (INSTRUCTOR) — QR 스캔 출석 확인
    - attendance.module.ts

  Step 7: 통합 + 환경설정 + 빌드 검증                              [완료]
    - app.module.ts: RedisModule, PaymentsModule, AttendanceModule import 추가
    - .env.example: REDIS_URL, PORTONE_API_SECRET, PORTONE_STORE_ID, PORTONE_CHANNEL_KEY, PORTONE_WEBHOOK_SECRET 추가
    - pnpm run build (turbo build) 전체 4 패키지 빌드 성공

Phase 2 빌드 중 수정한 사항:
  - controller의 @Req() → @Request() + { user: { id: string } } 타입 추가 (strict 모드 대응)
  - @ApiBearerAuth() 데코레이터 추가 (Swagger 문서 정합성)

################################################################################
# PART 5: Phase 2 완료 후 전체 코드 구조
################################################################################

apps/server/src/
  app.module.ts           — 루트 (ConfigModule, PrismaModule, RedisModule, AuthModule, ProgramsModule, ReservationsModule, PaymentsModule, AttendanceModule)
  main.ts                 — NestJS 부트스트랩
  prisma/
    prisma.module.ts      — @Global() PrismaModule
    prisma.service.ts     — PrismaClient 래퍼
    schema.prisma         — User, Program, Reservation, Gallery, Payment, Attendance
                            + UserRole, ReservationStatus, PaymentMethod, PaymentStatus, AttendanceStatus enum
  auth/
    auth.module.ts, auth.controller.ts, auth.service.ts
    jwt.strategy.ts, jwt-auth.guard.ts, roles.guard.ts, roles.decorator.ts
  programs/
    programs.module.ts, programs.controller.ts, programs.service.ts, dto/
  reservations/
    reservations.module.ts    — imports: PaymentsModule
    reservations.controller.ts
    reservations.service.ts   — create(Redis락+PENDING), cancel(PortOne환불), findAll, findOne
    dto/                      — create-reservation.dto.ts, query-reservation.dto.ts
  redis/
    redis.module.ts           — @Global()
    redis.service.ts          — acquireLock, releaseLock (Lua)
  payments/
    payments.module.ts        — exports: PaymentsService
    payments.controller.ts    — POST /payments/prepare, POST /payments/webhook
    payments.service.ts       — preparePayment, handleWebhook, processRefund
    portone.service.ts        — PortOne V2 REST (preRegister, getPaymentDetail, requestRefund)
    dto/
      prepare-payment.dto.ts
      webhook-payload.dto.ts
  attendance/
    attendance.module.ts
    attendance.controller.ts  — POST /check, GET /qr/:id, POST /qr/verify
    attendance.service.ts     — markAttendance, getQrCode, verifyQrCode
    dto/
      mark-attendance.dto.ts
      verify-qr.dto.ts

packages/shared/src/
  index.ts                — 모든 타입/상수 re-export
  constants/index.ts      — REFUND_POLICY, SOFT_LOCK_DURATION_MS, PRE_ACTIVITY_NOTIFICATION_HOURS,
                            REDIS_LOCK_TTL_MS, REDIS_LOCK_RETRY_INTERVAL_MS, REDIS_LOCK_MAX_RETRIES
  types/
    user.ts               — UserRole enum, User interface, AuthResponse interface
    program.ts            — Program interface
    reservation.ts        — ReservationStatus enum, Reservation interface
    gallery.ts            — Gallery interface
    payment.ts            — PaymentMethod enum, PaymentStatus enum, Payment interface
    attendance.ts         — AttendanceStatus enum, Attendance interface

################################################################################
# PART 6: 전체 API 엔드포인트 (Phase 2 완료 기준)
################################################################################

인증:
  POST /auth/register          — 로컬 회원가입
  POST /auth/login             — 로컬 로그인 (JWT 발급)
  POST /auth/kakao             — 카카오 OAuth 로그인

프로그램:
  GET  /programs               — 프로그램 검색/조회 (Public)
  GET  /programs/:id           — 프로그램 상세 (Public)
  POST /programs               — 프로그램 생성 (INSTRUCTOR)
  PATCH /programs/:id          — 프로그램 수정 (INSTRUCTOR)
  DELETE /programs/:id         — 프로그램 삭제 (INSTRUCTOR)

예약:
  POST /reservations           — 예약 생성 (PENDING + Redis 락)
  GET  /reservations           — 내 예약 목록
  GET  /reservations/:id       — 예약 상세
  PATCH /reservations/:id/cancel — 예약 취소 (PortOne 실제 환불)

결제:
  POST /payments/prepare       — 결제 세션 생성 (JWT)
  POST /payments/webhook       — PortOne 웹훅 수신 (인증 없음)

출석:
  POST /attendance/check       — 수동 출석 체크 (INSTRUCTOR)
  GET  /attendance/qr/:reservationId — QR 코드 조회 (JWT)
  POST /attendance/qr/verify   — QR 스캔 출석 확인 (INSTRUCTOR)

환경변수 (.env.example):
  DATABASE_URL, PORT, JWT_SECRET, KAKAO_REST_API_KEY,
  REDIS_URL, PORTONE_API_SECRET, PORTONE_STORE_ID, PORTONE_CHANNEL_KEY, PORTONE_WEBHOOK_SECRET

################################################################################
# PART 7: 다음 단계 — Phase 3 (알림 자동화 + 사진첩 고도화)
################################################################################

PRD 기반 Phase 3 예상 범위:
  - 활동 24시간 전 자동 알림 (Push/SMS) — Cron Job + FCM
  - 강사가 갤러리 업로드 후 부모에게 Push 알림
  - 이미지 업로드 최적화 (S3 + Lambda 리사이징 + CDN)
  - 갤러리 접근 권한 (해당 예약자만 Signed URL)

Phase 3 작업 재개 시:
  이 파일을 컨텍스트로 전달하고:
    "이 파일 읽고 Phase 3 계획 세워줘"
  라고 요청하면 됨.

================================================================================
