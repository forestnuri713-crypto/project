generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PARENT
  INSTRUCTOR
  ADMIN
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentMethod {
  KAKAO_PAY
  TOSS_PAY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  REFUNDED
  PARTIAL_REFUND
}

enum WebhookProvider {
  PORTONE
}

enum WebhookEventStatus {
  RECEIVED
  PROCESSED
  IGNORED
  FAILED
}

enum AttendanceStatus {
  ATTENDED
  NO_SHOW
}

enum NotificationType {
  PRE_ACTIVITY
  GALLERY_UPLOADED
  PROGRAM_APPROVED
  PROGRAM_REJECTED
  SETTLEMENT_CREATED
  INSTRUCTOR_APPROVED
  INSTRUCTOR_REJECTED
  RESERVATION_BULK_CANCELLED
}

enum BulkCancelJobStatus {
  PENDING
  RUNNING
  COMPLETED
  COMPLETED_WITH_ERRORS
  FAILED
}

enum BulkCancelItemResult {
  SUCCESS
  FAILED
  SKIPPED
}

enum InstructorStatus {
  NONE
  APPLIED
  APPROVED
  REJECTED
}

enum ApprovalStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ProgramScheduleStatus {
  ACTIVE
  CANCELLED
}

enum SettlementStatus {
  PENDING
  CONFIRMED
  PAID
}

enum PaymentSettlementStatus {
  PENDING
  CONFIRMED
  PAID
}

enum PayoutStatus {
  INITIATED
  SUCCESS
  FAILED
}

enum ProviderRole {
  OWNER
  MANAGER
  INSTRUCTOR
}

enum ProviderMemberStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum ReviewStatus {
  VISIBLE
  HIDDEN
}

model User {
  id                 String   @id @default(uuid())
  email              String   @unique
  name               String
  role               UserRole
  kakaoId            String?  @unique @map("kakao_id")
  profileImageUrl    String?  @map("profile_image_url")
  phoneNumber        String   @map("phone_number")
  fcmToken           String?  @map("fcm_token")
  messageCashBalance     Int              @default(0) @map("message_cash_balance")
  instructorStatus       InstructorStatus @default(NONE) @map("instructor_status")
  instructorStatusReason String?          @map("instructor_status_reason")
  certifications         Json             @default("[]")
  slug                   String?          @unique
  slugChangeCount        Int              @default(0) @map("slug_change_count")
  createdAt              DateTime         @default(now()) @map("created_at")
  updatedAt              DateTime         @updatedAt @map("updated_at")

  programs           Program[]
  reservations       Reservation[]
  checkedAttendances Attendance[]  @relation("AttendanceChecker")
  notifications      Notification[]
  uploadedPhotos     Gallery[]     @relation("GalleryUploader")
  settlements        Settlement[]
  providerMemberships ProviderMember[]
  reviews              Review[]
  bulkCancelJobs       BulkCancelJob[]

  @@map("users")
}

model Program {
  id              String         @id @default(uuid())
  instructorId    String         @map("instructor_id")
  title           String
  description     String
  location        String
  latitude        Float
  longitude       Float
  price           Int
  maxCapacity     Int            @map("max_capacity")
  minAge          Int            @map("min_age")
  scheduleAt      DateTime       @map("schedule_at")
  approvalStatus  ApprovalStatus @default(PENDING_REVIEW)
  rejectionReason String?        @map("rejection_reason")
  isB2b            Boolean        @default(false) @map("is_b2b")
  safetyGuide      String?        @map("safety_guide")
  insuranceCovered Boolean        @default(false) @map("insurance_covered")
  ratingAvg        Float          @default(0) @map("rating_avg")
  reviewCount      Int            @default(0) @map("review_count")
  reservedCount    Int            @default(0) @map("reserved_count")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  providerId       String?        @map("provider_id")

  instructor   User          @relation(fields: [instructorId], references: [id])
  provider     Provider?     @relation(fields: [providerId], references: [id])
  reservations   Reservation[]
  schedules      ProgramSchedule[]
  gallery        Gallery[]
  reviews        Review[]
  bulkCancelJobs BulkCancelJob[]
  categories     ProgramCategory[]

  @@index([approvalStatus])
  @@map("programs")
}

model ProgramSchedule {
  id        String                @id @default(uuid())
  programId String                @map("program_id")
  startAt   DateTime              @map("start_at")
  endAt     DateTime?             @map("end_at")
  capacity          Int
  remainingCapacity Int                   @map("remaining_capacity")
  status            ProgramScheduleStatus @default(ACTIVE)
  createdAt DateTime              @default(now()) @map("created_at")
  updatedAt DateTime              @updatedAt @map("updated_at")

  program      Program       @relation(fields: [programId], references: [id])
  reservations Reservation[]

  @@unique([programId, startAt])
  @@index([startAt])
  @@index([programId])
  @@map("program_schedules")
}

model Reservation {
  id                 String            @id @default(uuid())
  userId             String            @map("user_id")
  programId          String            @map("program_id")
  programScheduleId  String?           @map("program_schedule_id")
  status             ReservationStatus @default(PENDING)
  participantCount   Int               @map("participant_count")
  totalPrice         Int               @map("total_price")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  user            User             @relation(fields: [userId], references: [id])
  program         Program          @relation(fields: [programId], references: [id])
  programSchedule ProgramSchedule? @relation(fields: [programScheduleId], references: [id])
  payment            Payment?
  attendance         Attendance?
  review             Review?
  bulkCancelJobItems BulkCancelJobItem[]

  @@index([programScheduleId])
  @@map("reservations")
}

model Payment {
  id               String        @id @default(uuid())
  reservationId    String        @unique @map("reservation_id")
  merchantUid      String        @unique @map("merchant_uid")
  method           PaymentMethod
  portonePaymentId String        @unique @map("portone_payment_id")
  amount           Int
  status           PaymentStatus @default(PENDING)
  paidAt           DateTime?     @map("paid_at")
  cancelledAt      DateTime?     @map("cancelled_at")
  failedAt         DateTime?     @map("failed_at")
  refundedAmount   Int           @default(0) @map("refunded_amount")
  refundedAt       DateTime?     @map("refunded_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  reservation       Reservation        @relation(fields: [reservationId], references: [id])
  paymentSettlement PaymentSettlement?

  @@map("payments")
}

model PaymentWebhookEvent {
  id          String             @id @default(uuid())
  provider    WebhookProvider
  eventKey    String             @map("event_key")
  merchantUid String?            @map("merchant_uid")
  eventType   String             @map("event_type")
  status      WebhookEventStatus @default(RECEIVED)
  rawBody     Json?              @map("raw_body")
  receivedAt  DateTime           @default(now()) @map("received_at")
  processedAt DateTime?          @map("processed_at")
  createdAt   DateTime           @default(now()) @map("created_at")

  @@unique([provider, eventKey])
  @@index([merchantUid])
  @@index([receivedAt])
  @@map("payment_webhook_events")
}

model PaymentSettlement {
  id            String                  @id @default(uuid())
  reservationId String                  @unique @map("reservation_id")
  paymentId     String                  @unique @map("payment_id")
  grossAmount   Int                     @map("gross_amount")
  platformRate  Decimal                 @map("platform_rate") @db.Decimal(5, 4)
  platformFee   Int                     @map("platform_fee")
  netAmount     Int                     @map("net_amount")
  status        PaymentSettlementStatus @default(PENDING)
  confirmedAt   DateTime?               @map("confirmed_at")
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")

  payment Payment  @relation(fields: [paymentId], references: [id])
  payouts Payout[]

  @@map("payment_settlements")
}

model Payout {
  id           String       @id @default(uuid())
  settlementId String       @map("settlement_id")
  payoutKey    String       @unique @map("payout_key")
  amount       Int
  status       PayoutStatus @default(INITIATED)
  executedAt   DateTime?    @map("executed_at")
  createdAt    DateTime     @default(now()) @map("created_at")

  settlement PaymentSettlement @relation(fields: [settlementId], references: [id])

  @@map("payouts")
}

model Attendance {
  id               String           @id @default(uuid())
  reservationId    String           @unique @map("reservation_id")
  status           AttendanceStatus @default(NO_SHOW)
  qrCode           String           @unique @map("qr_code")
  checkedAt        DateTime?        @map("checked_at")
  checkedBy        String?          @map("checked_by")
  checkinLatitude  Float?           @map("checkin_latitude")
  checkinLongitude Float?           @map("checkin_longitude")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  reservation Reservation @relation(fields: [reservationId], references: [id])
  checker     User?       @relation("AttendanceChecker", fields: [checkedBy], references: [id])

  @@map("attendances")
}

model Gallery {
  id           String   @id @default(uuid())
  programId    String   @map("program_id")
  imageKey     String   @map("image_key")
  thumbnailKey String   @map("thumbnail_key")
  uploadedBy   String   @map("uploaded_by")
  createdAt    DateTime @default(now()) @map("created_at")

  program  Program @relation(fields: [programId], references: [id])
  uploader User    @relation("GalleryUploader", fields: [uploadedBy], references: [id])

  @@map("gallery")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  body      String
  isRead    Boolean          @default(false) @map("is_read")
  data      Json?
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@map("notifications")
}

model Settlement {
  id               String           @id @default(uuid())
  instructorId     String           @map("instructor_id")
  periodStart      DateTime         @map("period_start")
  periodEnd        DateTime         @map("period_end")
  grossAmount      Int              @map("gross_amount")
  refundAmount     Int              @map("refund_amount")
  platformFee      Int              @map("platform_fee")
  notificationCost Int              @map("notification_cost")
  b2bCommission    Int              @map("b2b_commission")
  netAmount        Int              @map("net_amount")
  status           SettlementStatus @default(PENDING)
  paidAt           DateTime?        @map("paid_at")
  memo             String?
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  instructor User @relation(fields: [instructorId], references: [id])

  @@unique([instructorId, periodStart, periodEnd])
  @@map("settlements")
}

model Provider {
  id           String   @id @default(uuid())
  name         String
  businessType String?  @map("business_type")
  regionTags   Json?    @map("region_tags")
  phone        String?
  email        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  members  ProviderMember[]
  profile  ProviderProfile?
  programs Program[]

  @@map("providers")
}

model ProviderMember {
  id             String               @id @default(uuid())
  providerId     String               @map("provider_id")
  userId         String               @map("user_id")
  roleInProvider ProviderRole         @map("role_in_provider")
  status         ProviderMemberStatus @default(ACTIVE)
  createdAt      DateTime             @default(now()) @map("created_at")

  provider Provider @relation(fields: [providerId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([providerId, userId])
  @@map("provider_members")
}

model ProviderProfile {
  id                 String   @id @default(uuid())
  providerId         String   @unique @map("provider_id")
  displayName        String   @map("display_name")
  introShort         String?  @map("intro_short")
  certificationsText String?  @map("certifications_text")
  storyText          String?  @map("story_text")
  coverImageUrls     Json     @default("[]") @map("cover_image_urls")
  contactLinks       Json     @default("[]") @map("contact_links")
  isPublished        Boolean  @default(false) @map("is_published")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  provider Provider @relation(fields: [providerId], references: [id])

  @@map("provider_profiles")
}

model Review {
  id            String       @id @default(uuid())
  programId     String       @map("program_id")
  reservationId String       @unique @map("reservation_id")
  parentUserId  String       @map("parent_user_id")
  rating        Int
  comment       String       @db.VarChar(300)
  status        ReviewStatus @default(VISIBLE)
  editedAt      DateTime?    @map("edited_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  program     Program     @relation(fields: [programId], references: [id])
  reservation Reservation @relation(fields: [reservationId], references: [id])
  parentUser  User        @relation(fields: [parentUserId], references: [id])

  @@map("reviews")
}

model BulkCancelJob {
  id                   String              @id @default(uuid())
  sessionId            String              @map("session_id")
  reason               String              @db.VarChar(200)
  mode                 String
  status               BulkCancelJobStatus @default(PENDING)
  totalTargets         Int                 @default(0) @map("total_targets")
  successCount         Int                 @default(0) @map("success_count")
  failedCount          Int                 @default(0) @map("failed_count")
  skippedCount         Int                 @default(0) @map("skipped_count")
  createdByAdminUserId String              @map("created_by_admin_user_id")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  startedAt            DateTime?           @map("started_at")
  finishedAt           DateTime?           @map("finished_at")

  program  Program             @relation(fields: [sessionId], references: [id])
  admin    User                @relation(fields: [createdByAdminUserId], references: [id])
  items    BulkCancelJobItem[]

  @@map("bulk_cancel_jobs")
}

model BulkCancelJobItem {
  id               String               @id @default(uuid())
  jobId            String               @map("job_id")
  reservationId    String               @map("reservation_id")
  result           BulkCancelItemResult @default(FAILED)
  failureCode      String?              @map("failure_code")
  failureMessage   String?              @map("failure_message")
  attemptedAt      DateTime             @default(now()) @map("attempted_at")
  refundedAmount   Int?                 @map("refunded_amount")
  notificationSent Boolean              @default(false) @map("notification_sent")

  job         BulkCancelJob @relation(fields: [jobId], references: [id])
  reservation Reservation   @relation(fields: [reservationId], references: [id])

  @@unique([jobId, reservationId])
  @@map("bulk_cancel_job_items")
}

model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  programs ProgramCategory[]

  @@map("categories")
}

model ProgramCategory {
  programId  String   @map("program_id")
  categoryId String   @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  program  Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([programId, categoryId])
  @@map("program_categories")
}
